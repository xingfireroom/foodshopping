<extend name="Index:base" />
<block name="content">
        <div class="main-content">
            <div class="breadcrumbs" id="breadcrumbs">
                <!-- 面包屑导航 -->
                <ul class="breadcrumb">
                    <li>
                        <i class="icon-home home-icon"></i>
                        <a href="{:U('Admin/Index/index')}">首页</a>
                    </li>
                    <li class="active">{$title}</li>
                </ul><!-- .breadcrumb -->
                
            </div>
            
            <div class="page-content">
                
                <!-- 页面导航 -->
                <div class="page-header">
                    <h1>
                        {$title}
                        <small>
                            <i class="icon-double-angle-right"></i>
                            查看
                        </small>
                    </h1>
                </div>
                

                <div class="row">
                    <div class="col-xs-12">
                        <div class="tabbable">
                            <ul id="myTab" class="nav nav-tabs">

                            <volist name="floors" id="vo">
                                <li id="ftitle-{$vo['frid']}" class="">
                                    <a href="#floor_{$vo['frid']}" data-toggle="tab">
                                        <i class="green icon-barcode bigger-110"></i>
                                        {$i}F--{$vo['cname']}
                                    </a>
                                </li>
                            </volist>
                                <!-- 添加按钮 -->
                                <li class="pull-right" style="position:relative;right:1px;">
                                    <a id="addfloor" data-toggle="modal" class="btn btn-info btn-sm " href="#addModal">
                                        <i class="icon-plus-sign bigger-110"></i>
                                        添加推荐
                                    </a> 
                                </li>
                            </ul>
                            <div class="tab-content">

                            <volist name="floors" id="vo">
                                <div id="floor_{$vo['frid']}" class="tab-pane">
                                    <div style="height:auto;overflow:hidden;">
                                    <h4 class="pink pull-left">
                                        <i class="icon-flag green"></i>
                                        <a class="blue" data-toggle="modal" role="button" href="#modal-form"> 图片设置</a>
                                    </h4>
                                    <a class="btn btn-info pull-left" style="padding:1px 10px;margin-left:20px;" href="{:U('Admin/Indexset/createPic',array('frid'=>$vo['frid']))}">
                                        <i class="icon-plus-sign bigger-125"></i>
                                        添加图片
                                    </a>
                                    <a id="delete-floor-{$vo['frid']}" name="{$i}F {$vo['cname']}" class="btn btn-danger btn-xs pull-right" style="padding:1px 10px;margin-left:5px;" data-toggle="modal" href="#deleteFloor">
                                        <i class="icon-bolt bigger-125"></i>
                                        删除推荐
                                    </a>
                                    <a id="edit-floor-{$vo['frid']}" ytag="{$vo['frsort']}" name="{$i}F {$vo['cname']}" class="btn btn-warning btn-xs pull-right" style="padding:1px 10px;margin-left:5px;" data-toggle="modal" href="#editFloor">
                                        <i class="icon-warning-sign bigger-125"></i>
                                        修改推荐信息
                                    </a>
                                    </div>
                                    <div class="hr hr-18 dotted hr-double"></div>
                                    <div class="row">
                                        <div class="col-xs-12">
                                            <div class="table-responsive">
                                                <table id="sample-table-1" class="table table-striped table-bordered table-hover">
                                                    <thead>
                                                        <tr>
                                                            <th>id</th>
                                                            <th class="widht-15">图片标题</th>
                                                            <th class="widht-15">图片url</th>
                                                            <th class="widht-15">有效期</th>
                                                            <th class="widht-15">缩略图</th>
                                                            <th class="widht-15">
                                                                <div class="dropdown" id="select-search">
                                                                    <a class="dropdown-toggle" href="#" data-toggle="dropdown">
                                                                        <span>广告位置</span>
                                                                        <i class="icon-caret-down bigger-110 width-auto"></i>
                                                                    </a>
                                                                    <ul class="dropdown-menu dropdown-info">
                                                                        <li>
                                                                            <a href="#floorads_0" >所有广告</a>
                                                                        </li>
                                                                        <li>
                                                                            <a href="#floorads_1" >左侧幻灯片</a>
                                                                        </li>
                                                                        <li>
                                                                            <a href="#floorads_2" >中间推荐位</a>
                                                                        </li>
                                                                        <li>
                                                                            <a href="#floorads_3" >右侧广告</a>
                                                                        </li>
                                                                    </ul>
                                                                </div>
                                                            </th>
                                                            <th style="width:100px;">操作</th>
                                                        </tr>
                                                    </thead>
                                                    <!--一行的开始-->
                                                    <!--遍历查询到的数据-->
                                                    <tbody id="floorset-{$vo['frid']}">

                                                    </tbody>
                                                </table>
                                            </div>
                                        </div><!-- /.col -->
                                    </div><!-- /.row -->

                                    <!-- 文字链接 -->
                                    <!--<div class="hr hr-18 dotted hr-double"></div>-->
                                    <!--<div style="height:auto;overflow:hidden;">-->
                                    <!--<h4 class="orange pull-left">-->
                                        <!--<i class="icon-flag orange"></i>-->
                                        <!--<a class="blue" data-toggle="modal" role="button" href="#modal-form"> 文字推荐</a>-->
                                    <!--</h4>-->
                                    <!--<a class="btn btn-warning pull-left" style="padding:1px 10px;margin-left:20px;" href="{:U('Admin/Indexset/createText',array('frid'=>$vo['frid']))}">-->
                                        <!--<i class="icon-plus-sign bigger-125"></i>-->
                                        <!--添加推荐-->
                                    <!--</a>-->
                                    <!--</div>-->
                                    <!--<div class="hr hr-18 dotted hr-double"></div>-->
                                    <!--<div class="row">-->
                                        <!--<div class="col-xs-12">-->
                                            <!--<div class="table-responsive">-->
                                                <!--<table id="sample-table-2" class="table table-striped table-bordered table-hover">-->
                                                    <!--<thead>-->
                                                        <!--<tr>-->
                                                            <!--<th>id</th>-->
                                                            <!--<th class="widht-15">文字推荐标题</th>-->
                                                            <!--<th class="widht-15">文字推荐url</th>-->
                                                            <!--<th style="width:100px;">操作</th>-->
                                                        <!--</tr>-->
                                                    <!--</thead>-->
                                                    <!--&lt;!&ndash;一行的开始&ndash;&gt;-->
                                                    <!--&lt;!&ndash;遍历查询到的数据&ndash;&gt;-->
                                                    <!--<tbody id="floortext-{$vo['frid']}">-->

                                                    <!--</tbody>-->
                                                <!--</table>-->
                                            <!--</div>-->
                                        <!--</div>-->
                                    <!--</div>-->
                                </div>
                            </volist>
                            </div>                            
                        </div>
                    </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- 中间部分结束 -->
        
        <!-- 删除按钮弹出层 -->
        <div class="modal modal-small fade" id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-dialog" style="width:300px;">
                <div class="modal-content" style="top:160px;left:80%;">
                    <div class="modal-header" style="height:40px;padding:5px 10px;line-height:30px;">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        <p class="bigger-120" id="myModalLabel">删除数据</p>
                    </div>
                    <div class="modal-body" style="height:70px;padding:5px 10px;line-height:60px;">
                        <p class="text-danger bigger-150">确定删除数据！</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-sm btn-danger" id="delete-data">删除</button>
                        <button type="button" class="btn btn-sm btn-default" data-dismiss="modal">取消</button>
                    </div>
                </div><!-- /.modal-content -->
            </div><!-- /.modal-dialog -->
        </div><!-- /.modal -->
        <!-- 删除按钮弹出层结束 -->
        
        <!-- 查看弹出层开始 -->
        <div class="modal modal-small fade" id="viewModal" tabindex="-1" role="dialog" aria-labelledby="viewModalLabel" aria-hidden="true">
            <div class="modal-dialog" style="padding:10px;">
                <div class="modal-content" >
                    <div class="modal-header" style="height:50px;padding:5px 10px;line-height:40px;">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        <p class="bigger-120" id="viewModalLabel"></p>
                    </div>
                    <div class="modal-body" style="padding:25px;">

                    </div>
                    <div class="modal-footer" style="margin:0px;padding:10px;">
                        <p class="text-primary align-left bigger-40 orange pull-left">连接：<span></span><br />有效期：<span></span></p>
                        <button type="button" class="btn btn-sm btn-primary" data-dismiss="modal">确定</button>
                    </div>
                </div><!-- /.modal-content -->
            </div><!-- /.modal-dialog -->
        </div><!-- /.modal -->
        <!-- 查看弹出层结束 -->

        <!-- 添加弹出层开始 -->
        <div class="modal modal-small fade" id="addModal" tabindex="-1" role="dialog" aria-labelledby="addModalLabel" aria-hidden="true">
            <div class="modal-dialog" style="padding:10px;">
                <div class="modal-content" style="top:50px;">
                    <div class="modal-header" style="height:50px;padding:5px 10px;line-height:40px;">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        <p class="bigger-120" id="addModalLabel">添加推荐</p>
                    </div>
                    <div class="modal-body" style="padding:25px;height:auto;overflow:hidden;">
                        <div class="form-group col-sm-12">
                            <label class="col-sm-2 control-label no-padding-right" style="line-height:25px;"> 推荐栏目 </label>
                            <div class="col-sm-10">
                                <div class="col-xs-10 col-sm-5 no-padding">
                                    <select id="floorsel" class="form-control" name="floorclass">
                                        <option value=""}>请选择本推荐栏目</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="form-group col-sm-12">
                            <label class="col-sm-2 control-label no-padding-right" style="line-height:25px;"> 排序 </label>
                            <div class="col-sm-10">
                                <input class="col-xs-10 col-sm-5" type="text" value="0" id="floor-sort" name="floorsort">
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer" style="margin:0px;padding:10px;">
                        <button id="addsure" type="button" class="btn btn-sm btn-primary" >添加推荐</button>
                        <button type="button" class="btn btn-sm btn-default" data-dismiss="modal">取消</button>
                    </div>
                </div><!-- /.modal-content -->
            </div><!-- /.modal-dialog -->
        </div><!-- /.modal -->
        <!-- 添加弹出层结束 -->

         <!-- 修改弹出层开始 -->
        <div class="modal modal-small fade" id="editFloor" tabindex="-1" role="dialog" aria-labelledby="editFloorLabel" aria-hidden="true">
            <div class="modal-dialog" style="padding:10px;">
                <div class="modal-content" style="top:50px;">
                    <div class="modal-header" style="height:50px;padding:5px 10px;line-height:40px;">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        <p class="bigger-120" id="editFloorLabel">修改推荐</p>
                    </div>
                    <div class="modal-body" style="padding:25px;height:auto;overflow:hidden;">
                        <div class="form-group col-sm-12">
                            <label class="col-sm-2 control-label no-padding-right" style="line-height:25px;"> 当前推荐 </label>
                            <div class="col-sm-10">
                                <input class="col-xs-10 col-sm-8" type="text" id="editfname" value="" disabled="disabled">
                            </div>
                        </div>
                        <div class="form-group col-sm-12">
                            <label class="col-sm-2 control-label no-padding-right" style="line-height:25px;"> 重设栏目 </label>
                            <div class="col-sm-10">
                                <div class="col-xs-10 col-sm-8 no-padding">
                                    <select id="floorsel-edit" class="form-control">
                                        <option value=""}>如果需要重设请选择</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="form-group col-sm-12">
                            <label class="col-sm-2 control-label no-padding-right" style="line-height:25px;"> 排序 </label>
                            <div class="col-sm-10">
                                <input class="col-xs-10 col-sm-8" type="text" value="0" id="floorsort">
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer" style="margin:0px;padding:10px;">
                        <button id="modifysure" type="button" class="btn btn-sm btn-primary" >确定修改</button>
                        <button type="button" class="btn btn-sm btn-default" data-dismiss="modal">取消</button>
                    </div>
                </div><!-- /.modal-content -->
            </div><!-- /.modal-dialog -->
        </div><!-- /.modal -->
        <!-- 修改弹出层结束 -->

        <!-- 删除推荐弹出层 -->
        <div class="modal modal-small fade" id="deleteFloor" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-dialog" style="width:400px;">
                <div class="modal-content" style="top:160px;left:80%;">
                    <div class="modal-header" style="height:40px;padding:5px 10px;line-height:30px;">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        <p class="bigger-120" id="myModalLabel">删除数据</p>
                    </div>
                    <div class="modal-body" style="height:120px;padding:20px 10px;">

                        <p class="text-danger bigger-120" style="padding-left:10px;">删除推荐，将删除推荐内的所有数据！</p>
                        <div class="form-group col-sm-12" style="padding:0px;">
                            <div class="col-sm-12" style="margin-bottom:10px;">
                                <label class="col-sm-3 col-xs-5 control-label no-padding-right" style="line-height:25px;"> 当前推荐 </label>
                                <input class="col-xs-7 col-sm-8" type="text" id="curr-floor-name" value="1F 手机" readonly>
                            </div>
                            <div class="col-sm-12">
                                <label class="col-sm-3 col-xs-5 control-label no-padding-right" style="line-height:25px;"> 密码 </label>
                                <input class="col-xs-7 col-sm-8" type="password" id="adminpwd" placeholder="请输入密码进行删除">
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-sm btn-danger" data-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-sm btn-default" id="deletefloor-data">确定删除</button>
                    </div>
                </div><!-- /.modal-content -->
            </div><!-- /.modal-dialog -->
        </div><!-- /.modal -->
        <!-- 删除推荐弹出层结束 -->

        
        <!-- 提示信息 -->
        <div id="success-info" class="alert alert-success fade in col-xs-4 hide" style="position:fixed;top:20px;left:35%;z-index:1000;">
            <button class="close" aria-hidden="true" data-dismiss="alert" type="button">×</button>
            <strong></strong>
        </div>
        <div id="error-info" class="alert alert-danger fade in col-xs-4 hide" style="position:fixed;top:20px;left:35%;z-index:1000;">
            <button class="close" aria-hidden="true" data-dismiss="alert" type="button">×</button>
            <strong></strong>
        </div>
</block>
<block name="privatejs">
    <script type="text/javascript">
        jQuery(function($) {         
            //设置当前页面的菜单高亮显示 开始
            var nownav = "#sidebar a[href*=Indexset]";
            var parentattr = $(nownav).parent().parent().attr("class");
            $(nownav).parent().addClass('active');
            if (parentattr == 'submenu') {
                $(nownav).parent().parent().parent().addClass('active open');
            };
            //设置当前页面的菜单高亮显示 结束

            //全选js
            $('table th input:checkbox').on('click' , function(){
                var that = this;
                $(this).closest('table').find('tr > td:first-child input:checkbox')
                .each(function(){
                     this.checked = that.checked;
                     $(this).closest('tr').toggleClass('selected');
                     });
            });

            //选项卡切换
            $('li a[href^=#floor_]').on('click',function(){
                floorsel = $(this).attr('href').split('_')[1];
                loadData(floorsel);
                loadText(floorsel);
            });

            //弹出框
            var delid;
            var delline;
            var ytag;
            $('div[class="tab-content"]').mouseover(function(){
                //查看
                $('a[name=table-view]').on('click',function(){
                    var viewline = $(this).parent().parent().parent();
                    $('#viewModal .modal-header p').html(viewline.children().eq(1).html());
                    $('#viewModal .modal-body').html("<img class='img-responsive' src='__PUBLIC__/Uploads/"+viewline.children().eq(4).children().attr("alt")+"' width='600'>");
                    $('#viewModal .modal-footer p span').eq(0).html(viewline.children().eq(2).html());
                    $('#viewModal .modal-footer p span').eq(1).html(viewline.children().eq(3).children().html());
                });

                $('a[name^=del]').on('click',function(){
                    delid = ($(this).attr('name').split('_'))[1];
                    delline = $(this).parent().parent().parent();
                    ytag = $(this).attr('ytag');
                });
            });

            //删除数据
            $('#delete-data').on('click',function(){
                $.ajax({
                    url:"__APP__/Admin/Indexset/deleteAd",
                    type:"post",
                    data:{fadid:delid,adtype:ytag},
                    success:function(data){
                    if (data == 1) {
                        delline.remove();
                        warningInfo('#success-info','删除数据成功!');
                    }else if(data == 2){
                        warningInfo("#error-info","没有删除权限！");
                    }else{
                        warningInfo('#error-info','删除数据失败!');
                    }
                    $('#deleteModal').modal('hide');
                    }
                });
            });

            //添加推荐框显示信息
            var view = 1;
            $('#addfloor').on('click',function(){
                if (view == 1) {
                   viewClass('#floorsel'); 
                };
                view++;
            });

            //添加推荐状态
            $('#addsure').on('click',function(){
                var fclass = $('#floorsel').val();
                var fsort = $('#floor-sort').val();
                if(fclass == ''){
                    $(this).attr("data-dismiss","");
                    return;
                }
                $.ajax({
                    url:"__APP__/Admin/Indexset/addFloor",
                    type:"post",
                    data:{cid:fclass,frsort:fsort},
                    success:function(data){
                        if (data == 1) {
                            warningInfo('#success-info','推荐添加成功!');
                            location.href="__APP__/Admin/Indexset/index";
                        }else if(data == 2){
                            warningInfo('#error-info','没有添加权限!');
                        }else{
                            warningInfo('#error-info','推荐添加失败!');
                        }
                    }
                });
                $(this).attr("data-dismiss","modal");
            });

            //修改推荐框显示信息
            var editfrid;
            var currview;
            $('a[id^=edit-floor]').on('click',function(){
                editfrid = $(this).attr('id').split('-')[2];
                if (editfrid != currview) {
                    viewClass('#floorsel-edit');
                };
                currview = editfrid;
                $('#editfname').val($(this).attr('name'));
                $('#floorsort').val($(this).attr('ytag'));
            });

            //修改推荐状态
            $('#modifysure').on('click',function(){
                var fclass = $('#floorsel-edit').val();
                var fsort = $('#floorsort').val();
                $.ajax({
                    url:"__APP__/Admin/Indexset/modifyFloor",
                    type:"post",
                    data:{cid:fclass,frsort:fsort,frid:editfrid},
                    success:function(data){
                        if (data == 1) {
                            warningInfo('#success-info','推荐修改成功!');
                            location.href="__APP__/Admin/Indexset/index";
                        }else if(data == 2){
                            warningInfo('#error-info','没有修改权限!');
                        }else{
                            warningInfo('#error-info','推荐修改失败!');
                        }
                    }
                });
                $(this).attr("data-dismiss","modal");
            });

            //删除推荐
            var deletefrid;

            $('a[id^=delete-floor-]').on('click',function(){
                deletefrid = $(this).attr('id').split('-')[2];
                $('#curr-floor-name').val($(this).attr('name'));
            });

            //删除ING
            $('#deletefloor-data').on('click',function(){
                var adminpwd = $('#adminpwd').val();
                if (adminpwd == '') {
                    $('#adminpwd').focus();
                    $('#adminpwd').css('color','red');
                    return;
                };
                $.ajax({
                    url:"__APP__/Admin/Indexset/deleteFloor",
                    type:"post",
                    data:{frid:deletefrid,adminpwd:adminpwd},
                    success:function(data){
                        if (data == 9) {
                            warningInfo('#error-info','推荐删除失败，密码错误！');
                        }else if(data == 2){
                            warningInfo('#error-info','没有删除权限!');
                        }else if(data == 1){
                            warningInfo('#success-info','推荐删除成功!');
                            location.href="__APP__/Admin/Indexset/index";
                        }else{
                            warningInfo('#error-info','推荐删除失败，部分数据可能被删除!');
                        }
                    }
                });
                $(this).attr("data-dismiss","modal");
            });

            //选择搜索
            var fadplace;
            $('#select-search ul li a').on('click',function(){
                $('#select-search>a>span').html($(this).html());
                fadplace = $(this).attr('href').split('_')[1];
                page = 1;
                loadData(floorsel,page,fadplace);
            });
            
            var curractive = $('div[id^=floor_]').attr('id').split('_')[1];
            //当前加载的数据
            var currurl = window.location.href.split('/floor/')[1];
            currurl = parseInt(currurl);
            if (currurl>0) {
                loadData(currurl,1,0);
                loadText(currurl,1);
                viewTab(currurl);
            }else{
                loadData(curractive,1,0);
                loadText(curractive,1);
                viewTab(curractive);
            }

            //信息提示函数
            function warningInfo(id,info){
                $(id).removeClass('hide');
                $(id).fadeOut(0);
                $(id).children().eq(1).html(info);
                $(id).fadeToggle(0).delay(1000).fadeToggle(1000);
            }

            function viewTab(currurl){
                $('#ftitle-'+currurl).toggleClass('active');
                $('#floor_'+currurl).toggleClass('active');
            }

            function loadData(floor,page,fadplace){
                $.ajax({
                    url:"__APP__/Admin/Indexset/loadData",
                    type:"post",
                    data:{frid:floor,page:page,fadplace:fadplace},
                    success:function(data){
                        $('#floorset-'+floor).html('');
                        $('#floorset-'+floor).html(data);
                    }
                })
            }

            function loadText(floor,tpage){
                $.ajax({
                    url:"__APP__/Admin/Indexset/loadText",
                    type:"post",
                    data:{frid:floor,page:tpage},
                    success:function(data){
                        $('#floortext-'+floor).html('');
                        $('#floortext-'+floor).html(data);
                    }
                })
            }

            function viewClass(id){
                $.ajax({
                    url:"__APP__/Admin/Indexset/viewClass",
                    type:"post",
                    datatype:'json',
                    success:function(data){
                        var datas = JSON.parse(data);
                        $(id).children().eq(0).nextAll().remove();
                        for (i in datas) {
                            $(id).append('<option value="'+datas[i].cid+'">'+datas[i].cname+'</option>');
                        };
                    }
                });
            }
        });
    </script>
</block>

